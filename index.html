<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baba Carriers Inc. - Professional Invoicing System</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* ==================== RESET & VARIABLES ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --success-color: #059669;
            --danger-color: #dc2626;
            --warning-color: #d97706;
            --info-color: #0891b2;
            --light-bg: #f8fafc;
            --white: #ffffff;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        /* ==================== BASE STYLES ==================== */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
            color: var(--text-dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ==================== HEADER ==================== */
        .app-header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
            color: var(--white);
            padding: 2rem;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .app-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .app-header p {
            font-size: 1.125rem;
            opacity: 0.9;
        }

        /* ==================== NAVIGATION TABS ==================== */
        .nav-tabs {
            display: flex;
            background: var(--white);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-light);
        }

        .nav-tab.active {
            background: var(--primary-color);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: var(--light-bg);
            color: var(--text-dark);
        }

        /* ==================== TAB CONTENT ==================== */
        .tab-content {
            display: none;
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .tab-content.active {
            display: block;
        }

        /* ==================== FORM STYLES ==================== */
        .form-section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
            display: inline-block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            position: relative;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .required {
            color: var(--danger-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--white);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group input.error {
            border-color: var(--danger-color);
            background-color: #fef2f2;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* ==================== PAYMENT OPTIONS ==================== */
        .payment-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .payment-option {
            position: relative;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            cursor: pointer;
            transition: var(--transition);
            background: var(--white);
        }

        .payment-option:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        .payment-option.selected {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.05);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .payment-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .payment-option-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .payment-option-icon {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            position: relative;
            transition: var(--transition);
        }

        .payment-option.selected .payment-option-icon {
            border-color: var(--primary-color);
            background: var(--primary-color);
        }

        .payment-option.selected .payment-option-icon::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: var(--white);
            border-radius: 50%;
        }

        .payment-option-text h4 {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
        }

        .payment-option-text p {
            font-size: 0.875rem;
            color: var(--text-light);
        }

        /* ==================== BUTTONS ==================== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--white);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #047857);
            color: var(--white);
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(5, 150, 105, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #b91c1c);
            color: var(--white);
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(220, 38, 38, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: var(--white);
        }

        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(107, 114, 128, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #b45309);
            color: var(--white);
        }

        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(217, 119, 6, 0.3);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* ==================== ACTION BAR ==================== */
        .action-bar {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin: 2rem 0;
            padding: 2rem;
            background: var(--light-bg);
            border-radius: 12px;
        }

        /* ==================== INVOICE PREVIEW ==================== */
        .invoice-preview {
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: var(--shadow);
            display: none;
        }

        .invoice-preview.show {
            display: block;
        }

        .invoice-content {
            background: var(--white);
            padding: 2rem;
            font-size: 14px;
            line-height: 1.4;
            color: #000;
            overflow-x: auto;
        }

        /* ==================== RESPONSIVE INVOICE CONTENT ==================== */
        @media (max-width: 768px) {
            .invoice-content {
                padding: 1rem;
                font-size: 16px;
                line-height: 1.5;
            }
            
            .invoice-content table {
                width: 100% !important;
                font-size: 16px !important;
            }
            
            .invoice-content h2 {
                font-size: 24px !important;
                margin-bottom: 1rem !important;
            }
            
            .invoice-content p {
                font-size: 16px !important;
                line-height: 1.6 !important;
                margin: 12px 0 !important;
            }
            
            .invoice-content td {
                padding: 12px 8px !important;
                font-size: 16px !important;
                line-height: 1.5 !important;
            }
            
            /* Make invoice header responsive */
            .invoice-content table:first-child td:first-child h2 {
                font-size: 22px !important;
                margin-bottom: 0.5rem !important;
            }
            
            .invoice-content table:first-child td:last-child p {
                font-size: 20px !important;
                font-weight: bold !important;
            }
            
            /* Payment section responsive */
            .invoice-content div[style*="margin-top: 40px"] {
                margin-top: 20px !important;
                padding: 15px !important;
                border: 2px solid #000 !important;
            }
            
            .invoice-content div[style*="margin-top: 40px"] p {
                font-size: 16px !important;
                line-height: 1.6 !important;
                margin: 10px 0 !important;
            }
        }

        @media (max-width: 480px) {
            .invoice-content {
                padding: 0.75rem;
                font-size: 18px;
            }
            
            .invoice-content table {
                font-size: 18px !important;
            }
            
            .invoice-content h2 {
                font-size: 26px !important;
            }
            
            .invoice-content p {
                font-size: 18px !important;
            }
            
            .invoice-content td {
                padding: 15px 10px !important;
                font-size: 18px !important;
            }
            
            .invoice-content table:first-child td:first-child h2 {
                font-size: 24px !important;
            }
            
            .invoice-content table:first-child td:last-child p {
                font-size: 22px !important;
            }
        }

        /* ==================== SAVED INVOICES ==================== */
        .saved-invoices {
            margin-top: 2rem;
        }

        .invoice-card {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .invoice-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .invoice-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .invoice-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .invoice-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            background: var(--success-color);
            color: var(--white);
        }

        .invoice-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .invoice-detail {
            font-size: 0.875rem;
        }

        .invoice-detail strong {
            color: var(--text-dark);
        }

        .invoice-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* ==================== STATISTICS ==================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* ==================== NOTIFICATIONS ==================== */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--success-color);
            color: var(--white);
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .notification.info {
            background: var(--info-color);
        }

        /* ==================== LOADING ==================== */
        .loading {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .app-header {
                padding: 1.5rem;
            }

            .app-header h1 {
                font-size: 2rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .payment-options {
                grid-template-columns: 1fr;
            }

            .action-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                justify-content: center;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .invoice-details {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ==================== PRINT STYLES ==================== */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .invoice-content,
            .invoice-content * {
                visibility: visible;
            }
            
            .invoice-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white !important;
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            @page {
                margin: 0.5in;
                size: letter;
            }
        }
    </style>
</head>
<body>
    <!-- Notification System -->
    <div id="notification" class="notification"></div>

    <div class="container">
        <!-- Application Header -->
        <header class="app-header">
            <h1>🚛 Baba Carriers Inc.</h1>
            <p>Professional Auto Invoicing System</p>
        </header>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('create')">📝 Create Invoice</button>
            <button class="nav-tab" onclick="switchTab('invoices')">📋 Saved Invoices</button>
            <button class="nav-tab" onclick="switchTab('statistics')">📊 Statistics</button>
            <button class="nav-tab" onclick="switchTab('settings')">⚙️ Settings</button>
        </div>

        <!-- Tab Content: Create Invoice -->
        <div id="create-tab" class="tab-content active">
            <form id="invoiceForm">
                <!-- Company Information -->
                <div class="form-section">
                    <h2 class="section-title">Company Information</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="invoiceNumber">Invoice Number <span class="required">*</span></label>
                            <input type="text" id="invoiceNumber" name="invoiceNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="invoiceDate">Invoice Date <span class="required">*</span></label>
                            <input type="text" id="invoiceDate" name="invoiceDate" placeholder="DD/MM/YYYY" required>
                        </div>
                    </div>
                </div>

                <!-- Customer Information -->
                <div class="form-section">
                    <h2 class="section-title">Customer Information</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="customerName">Customer Name <span class="required">*</span></label>
                            <input type="text" id="customerName" name="customerName" required>
                        </div>
                        <div class="form-group">
                            <label for="customerAddress">Customer Address</label>
                            <input type="text" id="customerAddress" name="customerAddress" placeholder="e.g., Attn: Accounts Payable">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="cityStateZip">City, State, Zip</label>
                        <input type="text" id="cityStateZip" name="cityStateZip" placeholder="e.g., Chicago, IL 60601">
                    </div>
                </div>

                <!-- Service Details -->
                <div class="form-section">
                    <h2 class="section-title">Service Details</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="loadNumber">Load Number</label>
                            <input type="text" id="loadNumber" name="loadNumber">
                        </div>
                        <div class="form-group">
                            <label for="truckNumber">Truck Number</label>
                            <input type="text" id="truckNumber" name="truckNumber">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">Service Description <span class="required">*</span></label>
                        <input type="text" id="description" name="description" required placeholder="e.g., FLAT RATE, TRANSPORTATION, DELIVERY">
                    </div>
                </div>

                <!-- Financial Details -->
                <div class="form-section">
                    <h2 class="section-title">Financial Details</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="amount">Service Amount <span class="required">*</span></label>
                            <input type="number" id="amount" name="amount" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="lumper">Lumper Fee</label>
                            <input type="number" id="lumper" name="lumper" step="0.01" min="0" value="0">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="deductions">Deductions</label>
                            <input type="number" id="deductions" name="deductions" step="0.01" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="charges">Additional Charges</label>
                            <input type="number" id="charges" name="charges" step="0.01" min="0" value="0">
                        </div>
                    </div>
                </div>

                <!-- Payment Assignment -->
                <div class="form-section">
                    <h2 class="section-title">Payment Assignment <span class="required">*</span></h2>
                    <div class="payment-options">
                        <div class="payment-option selected" onclick="selectPaymentOption('thunder')">
                            <input type="radio" id="thunderOption" name="paymentOption" value="thunder" checked>
                            <div class="payment-option-content">
                                <div class="payment-option-icon"></div>
                                <div class="payment-option-text">
                                    <h4>Thunder Funding Dept.</h4>
                                    <p>Memphis, TN - Default Option</p>
                                </div>
                            </div>
                        </div>
                        <div class="payment-option" onclick="selectPaymentOption('werner')">
                            <input type="radio" id="wernerOption" name="paymentOption" value="werner">
                            <div class="payment-option-content">
                                <div class="payment-option-icon"></div>
                                <div class="payment-option-text">
                                    <h4>Werner Enterprises</h4>
                                    <p>Omaha, NE - Alternative Option</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Bar -->
                <div class="action-bar">
                    <button type="button" class="btn btn-primary" onclick="generateInvoice()">
                        📄 Generate & Save Invoice
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearForm()">
                        🔄 Clear Form
                    </button>
                    <button type="button" class="btn btn-success" onclick="exportCurrentToExcel()" id="exportCurrentBtn" disabled>
                        📊 Export to Excel
                    </button>
                    <button type="button" class="btn btn-danger" onclick="generatePDF()" id="generatePDFBtn" disabled>
                        📄 Generate PDF
                    </button>
                </div>
            </form>

            <!-- Invoice Preview -->
            <div id="invoicePreview" class="invoice-preview">
                <div class="invoice-content" id="invoiceContent">
                    <!-- Invoice content will be generated here -->
                </div>
                <div class="action-bar">
                    <button type="button" class="btn btn-primary" onclick="window.print()">
                        🖨️ Print Invoice
                    </button>
                    <button type="button" class="btn btn-success" onclick="generatePDF()">
                        📄 Download PDF
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab Content: Saved Invoices -->
        <div id="invoices-tab" class="tab-content">
            <div class="saved-invoices">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 class="section-title">Saved Invoices</h2>
                    <div>
                        <button class="btn btn-success btn-sm" onclick="exportAllToExcel()">
                            📊 Export All to Excel
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="clearAllInvoices()">
                            🗑️ Clear All
                        </button>
                    </div>
                </div>
                <div id="savedInvoicesList">
                    <!-- Saved invoices will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Tab Content: Statistics -->
        <div id="statistics-tab" class="tab-content">
            <h2 class="section-title">Invoice Statistics</h2>
            <div class="stats-grid" id="statsGrid">
                <!-- Statistics will be loaded here -->
            </div>
        </div>

        <!-- Tab Content: Settings -->
        <div id="settings-tab" class="tab-content">
            <h2 class="section-title">Application Settings</h2>
            <div class="form-section">
                <div class="action-bar">
                    <button class="btn btn-success" onclick="downloadBackup()">
                        💾 Download Backup
                    </button>
                    <button class="btn btn-secondary" onclick="restoreBackup()">
                        📁 Restore Backup
                    </button>
                    <button class="btn btn-info btn-secondary" onclick="showDataStatus()">
                        📊 Data Status
                    </button>
                    <button class="btn btn-danger" onclick="clearAllData()">
                        🗑️ Clear All Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for backup restore -->
    <input type="file" id="backupFileInput" accept=".json" style="display: none;">

    <script>
        // ==================== APPLICATION CORE ====================
        
        class InvoiceManager {
            constructor() {
                this.storageKey = 'babaCarriers_invoices';
                this.backupKey = 'babaCarriers_backup';
                this.settingsKey = 'babaCarriers_settings';
                this.currentInvoice = null;
                this.invoices = [];
                this.init();
            }

            init() {
                this.loadInvoices();
                this.setupEventListeners();
                this.generateInvoiceNumber();
                this.setDefaultDate();
                this.updateStatistics();
                this.renderSavedInvoices();
                console.log('✅ Invoice Manager initialized');
            }

            setupEventListeners() {
                // Form validation on input
                document.addEventListener('input', (e) => {
                    if (e.target.matches('#amount, #lumper, #deductions, #charges')) {
                        this.validateNumberInput(e.target);
                    }
                });

                // Auto-save form data on input
                document.addEventListener('input', (e) => {
                    if (e.target.form && e.target.form.id === 'invoiceForm') {
                        this.autoSaveFormData();
                    }
                });

                // Backup file input handler
                document.getElementById('backupFileInput').addEventListener('change', (e) => {
                    this.handleBackupRestore(e);
                });
            }

            // ==================== DATA MANAGEMENT ====================

            loadInvoices() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    this.invoices = stored ? JSON.parse(stored) : [];
                    console.log(`📊 Loaded ${this.invoices.length} invoices`);
                } catch (error) {
                    console.error('Error loading invoices:', error);
                    this.invoices = [];
                    this.showNotification('Error loading saved invoices', 'error');
                }
            }

            saveInvoices() {
                try {
                    const data = JSON.stringify(this.invoices);
                    localStorage.setItem(this.storageKey, data);
                    localStorage.setItem(this.backupKey, data);
                    localStorage.setItem('babaCarriers_lastSave', new Date().toISOString());
                    console.log('💾 Invoices saved successfully');
                    return true;
                } catch (error) {
                    console.error('Error saving invoices:', error);
                    this.showNotification('Error saving invoices', 'error');
                    return false;
                }
            }

            // ==================== INVOICE OPERATIONS ====================

            generateInvoice() {
                if (!this.validateForm()) {
                    return;
                }

                const formData = this.getFormData();
                const invoice = this.createInvoiceObject(formData);
                
                // Save invoice
                this.invoices.push(invoice);
                this.currentInvoice = invoice;
                
                if (this.saveInvoices()) {
                    this.showInvoicePreview(invoice);
                    this.enableExportButtons();
                    this.updateStatistics();
                    this.renderSavedInvoices();
                    this.showNotification('Invoice generated and saved successfully!', 'success');
                } else {
                    this.showNotification('Error saving invoice', 'error');
                }
            }

            createInvoiceObject(formData) {
                const total = formData.amount + formData.lumper - formData.deductions + formData.charges;
                
                return {
                    id: Date.now(),
                    invoiceNumber: formData.invoiceNumber,
                    date: formData.invoiceDate,
                    customerName: formData.customerName,
                    customerAddress: formData.customerAddress || '',
                    cityStateZip: formData.cityStateZip || '',
                    loadNumber: formData.loadNumber || '',
                    truckNumber: formData.truckNumber || '',
                    description: formData.description,
                    amount: formData.amount,
                    lumper: formData.lumper,
                    deductions: formData.deductions,
                    charges: formData.charges,
                    total: total,
                    paymentOption: formData.paymentOption,
                    createdAt: new Date().toISOString(),
                    status: 'Generated'
                };
            }

            showInvoicePreview(invoice) {
                const content = this.generateInvoiceHTML(invoice);
                document.getElementById('invoiceContent').innerHTML = content;
                document.getElementById('invoicePreview').classList.add('show');
                
                // Scroll to preview
                document.getElementById('invoicePreview').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }

            generateInvoiceHTML(invoice) {
                const descriptionWithTruck = invoice.truckNumber ? 
                    `${invoice.description} - Truck: ${invoice.truckNumber}` : 
                    invoice.description;

                const paymentSection = this.generatePaymentSection(invoice.paymentOption);

                return `
                    <table style="width: 100%; border: none; margin-bottom: 25px;">
                        <tr>
                            <td style="width: 60%; border: none; vertical-align: top; padding: 0;">
                                <h2 style="margin: 0; font-size: 20px; font-weight: bold; color: #000;">Baba Carriers Inc.</h2>
                                <p style="margin: 8px 0; line-height: 1.5; font-size: 13px; color: #000;">
                                    USDOT No.: 4176122<br>
                                    Dept. #3003<br>
                                    P. O. Box 1000<br>
                                    Memphis, Tennessee 38148-3003<br>
                                    Co. Phone:<br>
                                    Accounting Phone: 1 (800) 240-4140
                                </p>
                            </td>
                            <td style="width: 40%; border: none; vertical-align: top; text-align: right; padding: 0;">
                                <p style="margin: 0; font-size: 18px; font-weight: bold; color: #000;">
                                    INVOICE NO: ${invoice.invoiceNumber}
                                </p>
                            </td>
                        </tr>
                    </table>

                    <table style="width: 100%; border: none; margin-bottom: 25px;">
                        <tr>
                            <td style="width: 60%; border: none; vertical-align: top; padding: 0;">
                                <p style="margin: 0; font-weight: bold; font-size: 14px; color: #000;">Bill To:</p>
                                <p style="margin: 8px 0; line-height: 1.5; font-size: 13px; color: #000;">
                                    Customer<br>
                                    Name: ${invoice.customerName}<br>
                                    Attn: ${invoice.customerAddress}<br>
                                    Address:<br>
                                    City, State, Zip: ${invoice.cityStateZip}
                                </p>
                            </td>
                            <td style="width: 40%; border: none; vertical-align: top; text-align: right; padding: 0;">
                                <p style="margin: 0; font-weight: bold; font-size: 14px; color: #000;">
                                    Date: ${invoice.date}
                                </p>
                            </td>
                        </tr>
                    </table>

                    <table style="width: 100%; border: none; margin-bottom: 25px;">
                        <tr>
                            <td style="border: none; padding: 12px 0;">
                                <p style="margin: 0; font-weight: bold; font-size: 14px; color: #000;">
                                    LOAD NUMBER<br>
                                    <span style="font-weight: normal;">${invoice.loadNumber}</span>
                                </p>
                            </td>
                        </tr>
                    </table>

                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <tr style="border-top: 2px solid #000; border-bottom: 2px solid #000;">
                            <td style="padding: 10px; font-weight: bold; width: 60%; font-size: 14px; color: #000;">DESCRIPTION</td>
                            <td style="padding: 10px; font-weight: bold; text-align: right; width: 40%; font-size: 14px; color: #000;">TOTAL</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; font-size: 13px; color: #000;">${descriptionWithTruck}</td>
                            <td style="padding: 10px; text-align: right; font-size: 13px; color: #000;">$${invoice.amount.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; font-weight: bold; font-size: 13px; color: #000;">SUB TOTAL</td>
                            <td style="padding: 10px; text-align: right; font-weight: bold; font-size: 13px; color: #000;">$${invoice.amount.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; font-size: 13px; color: #000;">LUMPER</td>
                            <td style="padding: 10px; text-align: right; font-size: 13px; color: #000;">$${invoice.lumper.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; font-size: 13px; color: #000;">DEDUCTIONS</td>
                            <td style="padding: 10px; text-align: right; font-size: 13px; color: #000;">$${invoice.deductions.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; font-size: 13px; color: #000;">CHARGES</td>
                            <td style="padding: 10px; text-align: right; font-size: 13px; color: #000;">$${invoice.charges.toFixed(2)}</td>
                        </tr>
                        <tr style="border-top: 2px solid #000; font-weight: bold;">
                            <td style="padding: 12px; font-size: 14px; color: #000;">TOTAL DUE</td>
                            <td style="padding: 12px; text-align: right; font-size: 14px; color: #000;">$${invoice.total.toFixed(2)}</td>
                        </tr>
                    </table>

                    ${paymentSection}
                `;
            }

            generatePaymentSection(paymentOption) {
                if (paymentOption === 'werner') {
                    return `
                        <div style="margin-top: 40px; padding: 20px; border: 2px solid #000;">
                            <p style="margin: 0 0 12px 0; font-weight: bold; font-size: 14px; color: #000;">
                                THIS INVOICE HAS BEEN ASSIGNED AND IS PAYABLE ONLY TO:
                            </p>
                            <p style="margin: 0 0 18px 0; line-height: 1.5; font-size: 13px; color: #000;">
                                Werner Enterprises.<br>
                                14507 Frontier Road,<br>
                                Omaha,<br>
                                NE 68138 | USA
                            </p>
                            <p style="margin: 0; line-height: 1.5; font-size: 13px; font-weight: bold; color: #000;">
                                Payment to a third party<br>
                                does not constitute payment.<br>
                                Any offsets and/or claims must be reported to 1 (800) 240-4140.
                            </p>
                        </div>
                    `;
                } else {
                    return `
                        <div style="margin-top: 40px; padding: 20px; border: 2px solid #000;">
                            <p style="margin: 0 0 12px 0; font-weight: bold; font-size: 14px; color: #000;">
                                THIS INVOICE HAS BEEN ASSIGNED AND IS PAYABLE ONLY TO:
                            </p>
                            <p style="margin: 0 0 18px 0; line-height: 1.5; font-size: 13px; color: #000;">
                                Thunder Funding Dept.<br>
                                #3003 P. O. Box 1000 Memphis,<br>
                                Tennessee 38148-3003
                            </p>
                            <p style="margin: 0; line-height: 1.5; font-size: 13px; color: #000;">
                                Payment to a third party does not constitute payment.<br>
                                Any offsets and/or claims must be reported to 1 (800) 240-4140.
                            </p>
                        </div>
                    `;
                }
            }

            // ==================== FORM OPERATIONS ====================

            validateForm() {
                const requiredFields = ['invoiceNumber', 'invoiceDate', 'customerName', 'description', 'amount'];
                let isValid = true;

                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (!field.value.trim()) {
                        field.classList.add('error');
                        isValid = false;
                    } else {
                        field.classList.remove('error');
                    }
                });

                const paymentOption = document.querySelector('input[name="paymentOption"]:checked');
                if (!paymentOption) {
                    this.showNotification('Please select a payment option', 'error');
                    isValid = false;
                }

                if (!isValid) {
                    this.showNotification('Please fill in all required fields', 'error');
                }

                return isValid;
            }

            getFormData() {
                return {
                    invoiceNumber: document.getElementById('invoiceNumber').value,
                    invoiceDate: document.getElementById('invoiceDate').value,
                    customerName: document.getElementById('customerName').value,
                    customerAddress: document.getElementById('customerAddress').value,
                    cityStateZip: document.getElementById('cityStateZip').value,
                    loadNumber: document.getElementById('loadNumber').value,
                    truckNumber: document.getElementById('truckNumber').value,
                    description: document.getElementById('description').value,
                    amount: parseFloat(document.getElementById('amount').value) || 0,
                    lumper: parseFloat(document.getElementById('lumper').value) || 0,
                    deductions: parseFloat(document.getElementById('deductions').value) || 0,
                    charges: parseFloat(document.getElementById('charges').value) || 0,
                    paymentOption: document.querySelector('input[name="paymentOption"]:checked').value
                };
            }

            clearForm() {
                document.getElementById('invoiceForm').reset();
                this.setDefaultDate();
                this.generateInvoiceNumber();
                this.selectPaymentOption('thunder');
                document.getElementById('invoicePreview').classList.remove('show');
                this.disableExportButtons();
                this.showNotification('Form cleared', 'info');
            }

            generateInvoiceNumber() {
                const now = new Date();
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                
                const invoiceNumber = `INV-${year}${month}${day}-${random}`;
                document.getElementById('invoiceNumber').value = invoiceNumber;
            }

            setDefaultDate() {
                const today = new Date();
                const day = today.getDate().toString().padStart(2, '0');
                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                const year = today.getFullYear();
                const dateString = `${day}/${month}/${year}`;
                document.getElementById('invoiceDate').value = dateString;
            }

            validateNumberInput(input) {
                const value = parseFloat(input.value);
                if (isNaN(value) || value < 0) {
                    input.classList.add('error');
                } else {
                    input.classList.remove('error');
                }
            }

            autoSaveFormData() {
                try {
                    const formData = this.getFormData();
                    localStorage.setItem('babaCarriers_formDraft', JSON.stringify(formData));
                } catch (error) {
                    // Silent fail for auto-save
                }
            }

            // ==================== EXPORT OPERATIONS ====================

            exportCurrentToExcel() {
                if (!this.currentInvoice) {
                    this.showNotification('No invoice to export', 'warning');
                    return;
                }

                this.createExcelFile([this.currentInvoice], `BabaCarriers_Invoice_${this.currentInvoice.invoiceNumber}`);
                this.showNotification('Invoice exported to Excel', 'success');
            }

            exportAllToExcel() {
                if (this.invoices.length === 0) {
                    this.showNotification('No invoices to export', 'warning');
                    return;
                }

                const timestamp = new Date().toISOString().split('T')[0];
                this.createExcelFile(this.invoices, `BabaCarriers_All_Invoices_${timestamp}`, true);
                this.showNotification(`Exported ${this.invoices.length} invoices to Excel`, 'success');
            }

            createExcelFile(invoices, filename, includeSummary = false) {
                const wb = XLSX.utils.book_new();

                if (includeSummary && invoices.length > 1) {
                    const summaryData = [
                        ['BABA CARRIERS INC. - INVOICE SUMMARY'],
                        ['Generated:', new Date().toLocaleString()],
                        ['Total Invoices:', invoices.length],
                        ['Total Amount:', `$${invoices.reduce((sum, inv) => sum + inv.total, 0).toFixed(2)}`],
                        [],
                        ['Invoice No.', 'Date', 'Customer', 'Load No.', 'Truck No.', 'Amount', 'Total Due', 'Payment To', 'Status']
                    ];

                    invoices.forEach(invoice => {
                        const paymentTo = invoice.paymentOption === 'werner' ? 'Werner Enterprises' : 'Thunder Funding';
                        summaryData.push([
                            invoice.invoiceNumber,
                            invoice.date,
                            invoice.customerName,
                            invoice.loadNumber || '',
                            invoice.truckNumber || '',
                            `$${invoice.amount.toFixed(2)}`,
                            `$${invoice.total.toFixed(2)}`,
                            paymentTo,
                            invoice.status || 'Generated'
                        ]);
                    });

                    const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                    XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
                }

                invoices.forEach((invoice, index) => {
                    const paymentInfo = this.getPaymentInfoForExcel(invoice.paymentOption);
                    
                    const invoiceData = [
                        ['BABA CARRIERS INC.'],
                        ['USDOT No.: 4176122'],
                        ['Dept. #3003'],
                        ['P. O. Box 1000'],
                        ['Memphis, Tennessee 38148-3003'],
                        ['Accounting Phone: 1 (800) 240-4140'],
                        [],
                        ['INVOICE NO:', invoice.invoiceNumber],
                        ['DATE:', invoice.date],
                        [],
                        ['BILL TO:'],
                        ['Customer Name:', invoice.customerName],
                        ['Customer Address:', invoice.customerAddress],
                        ['City, State, Zip:', invoice.cityStateZip],
                        [],
                        ['LOAD NUMBER:', invoice.loadNumber],
                        ['TRUCK NUMBER:', invoice.truckNumber],
                        [],
                        ['DESCRIPTION', 'AMOUNT'],
                        [invoice.description, `$${invoice.amount.toFixed(2)}`],
                        [],
                        ['SUB TOTAL', `$${invoice.amount.toFixed(2)}`],
                        ['LUMPER', `$${invoice.lumper.toFixed(2)}`],
                        ['DEDUCTIONS', `$${invoice.deductions.toFixed(2)}`],
                        ['CHARGES', `$${invoice.charges.toFixed(2)}`],
                        ['TOTAL DUE', `$${invoice.total.toFixed(2)}`],
                        [],
                        ...paymentInfo
                    ];

                    const ws = XLSX.utils.aoa_to_sheet(invoiceData);
                    const sheetName = invoices.length === 1 ? 'Invoice' : 
                                     `INV_${invoice.invoiceNumber}`.substring(0, 31);
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                });

                XLSX.writeFile(wb, `${filename}.xlsx`);
            }

            getPaymentInfoForExcel(paymentOption) {
                if (paymentOption === 'werner') {
                    return [
                        ['THIS INVOICE HAS BEEN ASSIGNED AND IS PAYABLE ONLY TO:'],
                        ['Werner Enterprises.'],
                        ['14507 Frontier Road,'],
                        ['Omaha,'],
                        ['NE 68138 | USA'],
                        [],
                        ['Payment to a third party'],
                        ['does not constitute payment.'],
                        ['Any offsets and/or claims must be reported to 1 (800) 240-4140.']
                    ];
                } else {
                    return [
                        ['THIS INVOICE HAS BEEN ASSIGNED AND IS PAYABLE ONLY TO:'],
                        ['Thunder Funding Dept.'],
                        ['#3003 P. O. Box 1000 Memphis,'],
                        ['Tennessee 38148-3003'],
                        [],
                        ['Payment to a third party does not constitute payment.'],
                        ['Any offsets and/or claims must be reported to 1 (800) 240-4140.']
                    ];
                }
            }

            // ==================== PDF OPERATIONS ====================

            async generatePDF() {
                if (!this.currentInvoice) {
                    this.showNotification('No invoice to generate PDF', 'warning');
                    return;
                }

                try {
                    // Show loading
                    this.showNotification('Generating PDF...', 'info');
                    
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const invoice = this.currentInvoice;
                    
                    // Create PDF directly without html2canvas
                    let yPos = 20;
                    const leftMargin = 20;
                    const rightMargin = 190;
                    
                    // Header - Company Info and Invoice Number
                    pdf.setFontSize(16);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Baba Carriers Inc.', leftMargin, yPos);
                    
                    pdf.setFontSize(14);
                    pdf.text(`INVOICE NO: ${invoice.invoiceNumber}`, rightMargin, yPos, { align: 'right' });
                    
                    yPos += 10;
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text('USDOT No.: 4176122', leftMargin, yPos);
                    yPos += 4;
                    pdf.text('Dept. #3003', leftMargin, yPos);
                    yPos += 4;
                    pdf.text('P. O. Box 1000', leftMargin, yPos);
                    yPos += 4;
                    pdf.text('Memphis, Tennessee 38148-3003', leftMargin, yPos);
                    yPos += 4;
                    pdf.text('Co. Phone:', leftMargin, yPos);
                    yPos += 4;
                    pdf.text('Accounting Phone: 1 (800) 240-4140', leftMargin, yPos);
                    
                    yPos += 15;
                    
                    // Bill To and Date
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Bill To:', leftMargin, yPos);
                    pdf.text(`Date: ${invoice.date}`, rightMargin, yPos, { align: 'right' });
                    
                    yPos += 6;
                    pdf.setFont('helvetica', 'normal');
                    pdf.text('Customer', leftMargin, yPos);
                    yPos += 4;
                    pdf.text(`Name: ${invoice.customerName}`, leftMargin, yPos);
                    yPos += 4;
                    pdf.text(`Attn: ${invoice.customerAddress}`, leftMargin, yPos);
                    yPos += 4;
                    pdf.text('Address:', leftMargin, yPos);
                    yPos += 4;
                    pdf.text(`City, State, Zip: ${invoice.cityStateZip}`, leftMargin, yPos);
                    
                    yPos += 15;
                    
                    // Load Number
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('LOAD NUMBER', leftMargin, yPos);
                    yPos += 5;
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(invoice.loadNumber || '', leftMargin, yPos);
                    
                    yPos += 15;
                    
                    // Service Table
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('DESCRIPTION', leftMargin, yPos);
                    pdf.text('TOTAL', rightMargin - 30, yPos, { align: 'right' });
                    
                    // Draw header line
                    pdf.line(leftMargin, yPos + 2, rightMargin, yPos + 2);
                    yPos += 8;
                    
                    // Service description
                    pdf.setFont('helvetica', 'normal');
                    const description = invoice.truckNumber ? 
                        `${invoice.description} - Truck: ${invoice.truckNumber}` : 
                        invoice.description;
                    pdf.text(description, leftMargin, yPos);
                    pdf.text(`$${invoice.amount.toFixed(2)}`, rightMargin - 30, yPos, { align: 'right' });
                    yPos += 6;
                    
                    // Subtotal
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('SUB TOTAL', leftMargin, yPos);
                    pdf.text(`$${invoice.amount.toFixed(2)}`, rightMargin - 30, yPos, { align: 'right' });
                    yPos += 6;
                    
                    // Other charges
                    pdf.setFont('helvetica', 'normal');
                    pdf.text('LUMPER', leftMargin, yPos);
                    pdf.text(`$${invoice.lumper.toFixed(2)}`, rightMargin - 30, yPos, { align: 'right' });
                    yPos += 6;
                    
                    pdf.text('DEDUCTIONS', leftMargin, yPos);
                    pdf.text(`$${invoice.deductions.toFixed(2)}`, rightMargin - 30, yPos, { align: 'right' });
                    yPos += 6;
                    
                    pdf.text('CHARGES', leftMargin, yPos);
                    pdf.text(`$${invoice.charges.toFixed(2)}`, rightMargin - 30, yPos, { align: 'right' });
                    yPos += 6;
                    
                    // Total line
                    pdf.line(leftMargin, yPos, rightMargin, yPos);
                    yPos += 5;
                    
                    // Total Due
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('TOTAL DUE', leftMargin, yPos);
                    pdf.text(`$${invoice.total.toFixed(2)}`, rightMargin - 30, yPos, { align: 'right' });
                    
                    yPos += 20;
                    
                    // Payment Assignment Box
                    const boxY = yPos;
                    pdf.rect(leftMargin, boxY, 150, 35);
                    
                    yPos += 8;
                    pdf.setFontSize(9);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('THIS INVOICE HAS BEEN ASSIGNED AND IS PAYABLE ONLY TO:', leftMargin + 5, yPos);
                    
                    yPos += 6;
                    pdf.setFont('helvetica', 'normal');
                    if (invoice.paymentOption === 'werner') {
                        pdf.text('Werner Enterprises.', leftMargin + 5, yPos);
                        yPos += 4;
                        pdf.text('14507 Frontier Road, Omaha, NE 68138 | USA', leftMargin + 5, yPos);
                        yPos += 6;
                        pdf.setFont('helvetica', 'bold');
                        pdf.text('Payment to a third party does not constitute payment.', leftMargin + 5, yPos);
                        yPos += 4;
                        pdf.text('Any offsets and/or claims must be reported to 1 (800) 240-4140.', leftMargin + 5, yPos);
                    } else {
                        pdf.text('Thunder Funding Dept.', leftMargin + 5, yPos);
                        yPos += 4;
                        pdf.text('#3003 P. O. Box 1000 Memphis, Tennessee 38148-3003', leftMargin + 5, yPos);
                        yPos += 6;
                        pdf.text('Payment to a third party does not constitute payment.', leftMargin + 5, yPos);
                        yPos += 4;
                        pdf.text('Any offsets and/or claims must be reported to 1 (800) 240-4140.', leftMargin + 5, yPos);
                    }
                    
                    pdf.save(`BabaCarriers_Invoice_${invoice.invoiceNumber}.pdf`);
                    this.showNotification('PDF generated successfully!', 'success');
                    
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    this.showNotification('Error generating PDF', 'error');
                }
            }

            // ==================== UI OPERATIONS ====================

            renderSavedInvoices() {
                const container = document.getElementById('savedInvoicesList');
                
                if (this.invoices.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                            <p>No invoices saved yet. Create your first invoice!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.invoices
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                    .map(invoice => this.createInvoiceCard(invoice))
                    .join('');
            }

            createInvoiceCard(invoice) {
                const paymentTo = invoice.paymentOption === 'werner' ? 'Werner Enterprises' : 'Thunder Funding';
                const createdDate = new Date(invoice.createdAt).toLocaleDateString();
                
                return `
                    <div class="invoice-card">
                        <div class="invoice-card-header">
                            <div class="invoice-number">${invoice.invoiceNumber}</div>
                            <div class="invoice-status">${invoice.status || 'Generated'}</div>
                        </div>
                        <div class="invoice-details">
                            <div class="invoice-detail">
                                <strong>Customer:</strong> ${invoice.customerName}
                            </div>
                            <div class="invoice-detail">
                                <strong>Date:</strong> ${invoice.date}
                            </div>
                            <div class="invoice-detail">
                                <strong>Load:</strong> ${invoice.loadNumber || 'N/A'}
                            </div>
                            <div class="invoice-detail">
                                <strong>Amount:</strong> $${invoice.total.toFixed(2)}
                            </div>
                            <div class="invoice-detail">
                                <strong>Payment To:</strong> ${paymentTo}
                            </div>
                            <div class="invoice-detail">
                                <strong>Created:</strong> ${createdDate}
                            </div>
                        </div>
                        <div class="invoice-actions">
                            <button class="btn btn-primary btn-sm" onclick="invoiceManager.viewInvoice(${invoice.id})">
                                👁️ View
                            </button>
                            <button class="btn btn-success btn-sm" onclick="invoiceManager.exportSingleInvoice(${invoice.id})">
                                📊 Excel
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="invoiceManager.generateInvoicePDF(${invoice.id})">
                                📄 PDF
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="invoiceManager.duplicateInvoice(${invoice.id})">
                                📋 Copy
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="invoiceManager.deleteInvoice(${invoice.id})">
                                🗑️ Delete
                            </button>
                        </div>
                    </div>
                `;
            }

            updateStatistics() {
                const stats = this.calculateStatistics();
                const container = document.getElementById('statsGrid');
                
                container.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalInvoices}</div>
                        <div class="stat-label">Total Invoices</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">$${stats.totalAmount.toFixed(0)}</div>
                        <div class="stat-label">Total Amount</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.thunderCount}</div>
                        <div class="stat-label">Thunder Funding</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.wernerCount}</div>
                        <div class="stat-label">Werner Enterprises</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">$${stats.averageAmount.toFixed(0)}</div>
                        <div class="stat-label">Average Amount</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.thisMonthCount}</div>
                        <div class="stat-label">This Month</div>
                    </div>
                `;
            }

            calculateStatistics() {
                const totalInvoices = this.invoices.length;
                const totalAmount = this.invoices.reduce((sum, inv) => sum + inv.total, 0);
                const thunderCount = this.invoices.filter(inv => inv.paymentOption === 'thunder').length;
                const wernerCount = this.invoices.filter(inv => inv.paymentOption === 'werner').length;
                const averageAmount = totalInvoices > 0 ? totalAmount / totalInvoices : 0;
                
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const thisMonthCount = this.invoices.filter(inv => {
                    const invDate = new Date(inv.date);
                    return invDate.getMonth() === currentMonth && invDate.getFullYear() === currentYear;
                }).length;

                return {
                    totalInvoices,
                    totalAmount,
                    thunderCount,
                    wernerCount,
                    averageAmount,
                    thisMonthCount
                };
            }

            // ==================== INVOICE ACTIONS ====================

            viewInvoice(id) {
                const invoice = this.invoices.find(inv => inv.id === id);
                if (!invoice) return;

                this.currentInvoice = invoice;
                this.showInvoicePreview(invoice);
                this.enableExportButtons();
                switchTab('create');
                
                // Scroll to preview
                setTimeout(() => {
                    document.getElementById('invoicePreview').scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }, 100);
            }

            exportSingleInvoice(id) {
                const invoice = this.invoices.find(inv => inv.id === id);
                if (!invoice) return;

                this.createExcelFile([invoice], `BabaCarriers_Invoice_${invoice.invoiceNumber}`);
                this.showNotification('Invoice exported to Excel', 'success');
            }

            async generateInvoicePDF(id) {
                const invoice = this.invoices.find(inv => inv.id === id);
                if (!invoice) return;

                // Temporarily show the invoice
                const originalInvoice = this.currentInvoice;
                this.currentInvoice = invoice;
                this.showInvoicePreview(invoice);
                
                // Wait for rendering
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await this.generatePDF();
                
                // Restore original state
                this.currentInvoice = originalInvoice;
                if (!originalInvoice) {
                    document.getElementById('invoicePreview').classList.remove('show');
                }
            }

            duplicateInvoice(id) {
                const invoice = this.invoices.find(inv => inv.id === id);
                if (!invoice) return;

                // Fill form with invoice data
                document.getElementById('invoiceNumber').value = '';
                document.getElementById('invoiceDate').value = invoice.date;
                document.getElementById('customerName').value = invoice.customerName;
                document.getElementById('customerAddress').value = invoice.customerAddress;
                document.getElementById('cityStateZip').value = invoice.cityStateZip;
                document.getElementById('loadNumber').value = invoice.loadNumber;
                document.getElementById('truckNumber').value = invoice.truckNumber;
                document.getElementById('description').value = invoice.description;
                document.getElementById('amount').value = invoice.amount;
                document.getElementById('lumper').value = invoice.lumper;
                document.getElementById('deductions').value = invoice.deductions;
                document.getElementById('charges').value = invoice.charges;
                
                this.selectPaymentOption(invoice.paymentOption);
                this.generateInvoiceNumber();
                
                switchTab('create');
                this.showNotification('Invoice duplicated to form', 'success');
            }

            deleteInvoice(id) {
                if (!confirm('Are you sure you want to delete this invoice?')) return;

                this.invoices = this.invoices.filter(inv => inv.id !== id);
                this.saveInvoices();
                this.renderSavedInvoices();
                this.updateStatistics();
                this.showNotification('Invoice deleted', 'success');
            }

            // ==================== UTILITY FUNCTIONS ====================

            enableExportButtons() {
                document.getElementById('exportCurrentBtn').disabled = false;
                document.getElementById('generatePDFBtn').disabled = false;
            }

            disableExportButtons() {
                document.getElementById('exportCurrentBtn').disabled = true;
                document.getElementById('generatePDFBtn').disabled = true;
            }

            showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type}`;
                
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }

            // ==================== DATA MANAGEMENT ====================

            downloadBackup() {
                const backupData = {
                    invoices: this.invoices,
                    timestamp: new Date().toISOString(),
                    version: '1.0',
                    source: 'Baba Carriers Inc. Professional Invoicing System'
                };
                
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `BabaCarriers_Backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showNotification('Backup downloaded successfully', 'success');
            }

            restoreBackup() {
                document.getElementById('backupFileInput').click();
            }

            handleBackupRestore(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (backupData.invoices && Array.isArray(backupData.invoices)) {
                            if (confirm(`This will restore ${backupData.invoices.length} invoices. Continue?`)) {
                                this.invoices = backupData.invoices;
                                this.saveInvoices();
                                this.renderSavedInvoices();
                                this.updateStatistics();
                                this.showNotification(`Restored ${backupData.invoices.length} invoices`, 'success');
                            }
                        } else {
                            throw new Error('Invalid backup file format');
                        }
                    } catch (error) {
                        this.showNotification('Invalid backup file', 'error');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            }

            showDataStatus() {
                const stats = this.calculateStatistics();
                const lastSave = localStorage.getItem('babaCarriers_lastSave');
                const storageUsed = new Blob([JSON.stringify(this.invoices)]).size;
                const hasPrimaryBackup = localStorage.getItem(this.backupKey) !== null;
                const hasSecondaryBackup = localStorage.getItem('babaCarriers_backup2') !== null;
                
                const statusMessage = `📊 DATA PERSISTENCE STATUS REPORT

🔒 PERSISTENCE GUARANTEE:
✅ Your data WILL survive:
   • Closing this HTML file
   • Closing your browser
   • Restarting your computer
   • Opening file again later

📊 CURRENT STATUS:
• Total Invoices: ${stats.totalInvoices}
• Total Amount: ${stats.totalAmount.toFixed(2)}
• Storage Used: ${(storageUsed / 1024).toFixed(2)} KB
• Last Save: ${lastSave ? new Date(lastSave).toLocaleString() : 'Never'}
• Primary Backup: ${hasPrimaryBackup ? '✅ Available' : '❌ Missing'}
• Secondary Backup: ${hasSecondaryBackup ? '✅ Available' : '❌ Missing'}

🗑️ DATA GETS DELETED ONLY WHEN:
❌ You manually clear browser data/cache
❌ You use private/incognito browsing mode  
❌ You click "Clear All Data" in this app
❌ Browser storage quota exceeded (very rare)

💡 RECOMMENDATION:
Use "Download Backup" regularly to save a copy of your data to your computer as an extra safety measure.

Your invoices are stored permanently in your browser's localStorage and will be available every time you open this file!`;
                
                alert(statusMessage);
            }

            clearAllInvoices() {
                if (!confirm('Are you sure you want to delete ALL invoices? This cannot be undone.')) return;

                this.invoices = [];
                this.saveInvoices();
                this.renderSavedInvoices();
                this.updateStatistics();
                this.showNotification('All invoices cleared', 'success');
            }

            clearAllData() {
                if (!confirm('This will delete ALL data including invoices and settings. Are you sure?')) return;

                localStorage.removeItem(this.storageKey);
                localStorage.removeItem(this.backupKey);
                localStorage.removeItem(this.settingsKey);
                localStorage.removeItem('babaCarriers_lastSave');
                localStorage.removeItem('babaCarriers_formDraft');
                
                this.invoices = [];
                this.currentInvoice = null;
                this.renderSavedInvoices();
                this.updateStatistics();
                this.clearForm();
                
                this.showNotification('All data cleared', 'success');
            }

            selectPaymentOption(option) {
                // Remove selected class from all options
                document.querySelectorAll('.payment-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Add selected class and check radio button
                if (option === 'thunder') {
                    document.getElementById('thunderOption').checked = true;
                    document.querySelector('.payment-option:nth-child(1)').classList.add('selected');
                } else {
                    document.getElementById('wernerOption').checked = true;
                    document.querySelector('.payment-option:nth-child(2)').classList.add('selected');
                }
            }
        }

        // ==================== GLOBAL FUNCTIONS ====================

        let invoiceManager;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            invoiceManager = new InvoiceManager();
            console.log('🚀 Professional Invoice System loaded successfully');
        });

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Add active class to selected nav tab
            event.target.classList.add('active');

            // Update statistics when switching to stats tab
            if (tabName === 'statistics') {
                invoiceManager.updateStatistics();
            }
        }

        // Payment option selection
        function selectPaymentOption(option) {
            invoiceManager.selectPaymentOption(option);
        }

        // Form operations
        function generateInvoice() {
            invoiceManager.generateInvoice();
        }

        function clearForm() {
            invoiceManager.clearForm();
        }

        function exportCurrentToExcel() {
            invoiceManager.exportCurrentToExcel();
        }

        function exportAllToExcel() {
            invoiceManager.exportAllToExcel();
        }

        function generatePDF() {
            invoiceManager.generatePDF();
        }

        // Settings operations
        function downloadBackup() {
            invoiceManager.downloadBackup();
        }

        function restoreBackup() {
            invoiceManager.restoreBackup();
        }

        function showDataStatus() {
            invoiceManager.showDataStatus();
        }

        function clearAllInvoices() {
            invoiceManager.clearAllInvoices();
        }

        function clearAllData() {
            invoiceManager.clearAllData();
        }

        console.log('✅ Professional Invoice System - Ready for use!');
    </script>
</body>
</html>
